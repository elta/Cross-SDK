#! /bin/bash

export PATH=${PREFIXHOSTTOOLS}/sbin:$PATH

[ -d ${PREFIXGNULINUX} ] || mkdir -p ${PREFIXGNULINUX}
[ -d ${METADATAMIPSELBUSYBOXCREATEIMG} ] || mkdir -p ${METADATAMIPSELBUSYBOXCREATEIMG}

pushd ${PREFIXGNULINUX}

[ -f ${METADATAMIPSELBUSYBOXCREATEIMG}/mipsel_busybox_ddimg ] || \
  dd if=/dev/zero of=${BUSYBOX_32_IMAGE} bs=4k count=512k || \
    die "dd mipsel busybox img error" && \
      touch ${METADATAMIPSELBUSYBOXCREATEIMG}/mipsel_busybox_ddimg

[ -f ${METADATAMIPSELBUSYBOXCREATEIMG}/mipsel_busybox_mkfsimg ] || \
  echo y | mkfs.ext3 ${BUSYBOX_32_IMAGE} || \
    die "mkfs mipsel busybox img error" && \
      touch ${METADATAMIPSELBUSYBOXCREATEIMG}/mipsel_busybox_mkfsimg

[ -d "${MOUNT_POINT}" ] || mkdir ${MOUNT_POINT}
if [ ${HOSTOS} = "Darwin" ]; then
  ext2fuse ${BUSYBOX_32_IMAGE} ${MOUNT_POINT}&
else
  sudo mount -o loop ${BUSYBOX_32_IMAGE} ${MOUNT_POINT}
fi

[ -f ${METADATAMIPSELBUSYBOXCREATEIMG}/mipsel_busybox_copy_files ] || \
  sudo cp -ar ${PREFIXMIPSELBUSYBOX}/* ${MOUNT_POINT} || \
    die "copy mipsel busybox files to img error" && \
      touch ${METADATAMIPSELBUSYBOXCREATEIMG}/mipsel_busybox_copy_files

sudo umount ${MOUNT_POINT}

[ -f ${METADATAMIPSELBUSYBOXCREATEIMG}/mipsel_sysroot_rmmnt ] || \
  rm -rf ${MOUNT_POINT} || \
    die "***remove mount point error" && \
      touch ${METADATAMIPSELBUSYBOXCREATEIMG}/mipsel_sysroot_rmmnt
popd

touch ${METADATAMIPSELBUSYBOXCREATEIMG}/mipsel_busybox_create_img_finished
