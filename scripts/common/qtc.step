#! /bin/bash

[ -d "${SRCUNIVERSAL}" ] ||  mkdir -p "${SRCUNIVERSAL}"
[ -d "${BUILDUNIVERSAL}" ] ||  mkdir -p "${BUILDUNIVERSAL}"
[ -d "${METADATAUNIVERSAL}" ] || mkdir -p "${METADATAUNIVERSAL}"
[ -d "${METADATAEXTRACT}" ] || mkdir -p "${METADATAEXTRACT}"

#################################################################
### universal extract
#################################################################
pushd ${SRCUNIVERSAL}
[ -f ${METADATAEXTRACT}/qtc_extract ] || \
tar xf ${TARBALL}/qt-creator-${QTC_VERSION}.${QTC_SUFFIX} || \
  die "extract qtc error" && \
    touch ${METADATAEXTRACT}/qtc_extract
popd

pushd ${SRCUNIVERSAL}
cd qt-creator-${QTC_VERSION}
[ -f ${METADATAUNIVERSAL}/qt_patch ] || \
  patch -p1 < ${LIVE_SRC}/${CROSSPROJECTMANAGER}/qt.patch || \
    die "patch qt-creator error" && \
      touch ${METADATAUNIVERSAL}/qt_patch
[ -d "src/plugins/crossprojectmanager" ] && \
  rm -rf src/plugins/crossprojectmanager
[ -f ${METADATAUNIVERSAL}/qt_copy ] || \
  cp -r ${LIVE_SRC}/${CROSSPROJECTMANAGER}/crossprojectmanager src/plugins/ || \
    die "copy crossprojectmanager error" && \
      touch ${METADATAUNIVERSAL}/qt_copy
popd

#################################################################
### qt-creator build
#################################################################
pushd ${BUILDUNIVERSAL}
[ -d "qt-creator-build" ] || mkdir qt-creator-build
cd qt-creator-build
[ -f "${METADATAUNIVERSAL}/qt-creator_configure" ] || \
  qmake PREFIX=${PREFIXQTC} \
   ${SRCUNIVERSAL}/qt-creator-${QTC_VERSION} || \
    die "***config qt-creator error" &&
      touch ${METADATAUNIVERSAL}/qt-creator_configure
[ -f "${METADATAUNIVERSAL}/qt-creator_build" ] || \
  make -j${JOBS} || die "***build qt-creator error" && \
    touch ${METADATAUNIVERSAL}/qt-creator_build

if [ ${HOSTOS} = "Darwin" ]; then
[ -f "${METADATAUNIVERSAL}/qt-creator_install" ] || \
  cp -a bin/Qt\ Creator.app ${PREFIX}/ || \
    die "***install qt-creator error" && \
      touch ${METADATAUNIVERSAL}/qt-creator_install
else
[ -f "${METADATAUNIVERSAL}/qt-creator_install" ] || \
  INSTALL_ROOT=${PREFIXQTC} make install || \
    die "***install qt-creator error" && \
      touch ${METADATAUNIVERSAL}/qt-creator_install
fi
popd
